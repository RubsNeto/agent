{% extends 'base.html' %}

{% block title %}{% if is_create %}Criar{% else %}Editar{% endif %} Agente - PanDia{% endblock %}
{% block page_title %}{% if is_create %}Criar Novo Agente{% else %}Editar Agente{% endif %}{% endblock %}

{% block content %}
<style>
    .preset-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .preset-card {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .preset-card:hover {
        border-color: var(--orange-500);
        background: rgba(245, 158, 11, 0.05);
    }

    .preset-card.selected {
        border-color: var(--orange-500);
        background: rgba(245, 158, 11, 0.1);
    }

    .preset-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
    }

    .preset-card p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .status-toggle-container {
        display: flex;
        gap: 1rem;
        padding: 0.5rem 0;
    }

    .status-option {
        flex: 1;
        position: relative;
    }

    .status-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .status-option label {
        display: block;
        padding: 1rem;
        border: 2px solid var(--gray-300);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .status-option input:checked+label {
        border-color: var(--green-500);
        background: rgba(16, 185, 129, 0.1);
        color: var(--green-700);
    }

    .status-option.inactive input:checked+label {
        border-color: var(--gray-500);
        background: var(--gray-100);
        color: var(--gray-700);
    }

    .pdf-preview {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .pdf-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .pdf-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .transfer-fields {
        background: var(--gray-50);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .transfer-fields.hidden {
        display: none;
    }

    .section-divider {
        border-top: 1px solid var(--gray-200);
        margin: 2rem 0;
    }

    /* Estilos para botões de dias de funcionamento */
    .day-button {
        background: white;
        color: var(--gray-700);
    }

    input[type="checkbox"]:checked+.day-button {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b !important;
    }

    /* Estilos para botões de dias de funcionamento */
    .day-button {
        background: white;
        color: #6b7280;
        transition: all 0.2s;
    }

    input[type="checkbox"]:checked+.day-button {
        background: linear-gradient(135deg, #f59e0b, #ea580c);
        color: white;
        border-color: #f59e0b !important;
    }

    .day-button:hover {
        border-color: #f59e0b !important;
        background: rgba(245, 158, 11, 0.05);
    }

    input[type="checkbox"]:checked+.day-button:hover {
        background: linear-gradient(135deg, #ea580c, #d97706);
    }
</style>

<a href="{% url 'agents:list' %}" class="back-link">
    ← Voltar para agente
</a>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; gap: 2rem;">
        <div style="flex: 1;">
            <h2 class="content-title" style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                    {% if is_create %}
                    <path d="M12 5v14M5 12h14" />
                    {% else %}
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    {% endif %}
                </svg>
                {% if is_create %}Criar Novo Agente{% else %}Editar Agente{% endif %}
            </h2>
            <p class="content-subtitle">Configure seu agente em minutos. É simples e rápido!</p>
        </div>

        {% if not is_create %}
        <div style="min-width: 420px;">
            <label class="form-label" style="margin-bottom: 0.75rem; display: block;">Status do Agente</label>
            <div class="status-toggle-container">
                {% for value, label in form.status_toggle.field.choices %}
                <div class="status-option {% if value == 'inativo' %}inactive{% endif %}">
                    <input type="radio" name="status_toggle_display" id="status_{{ value }}_top" value="{{ value }}"
                        onchange="document.getElementById('status_toggle_hidden').value = this.value" {% if
                        form.status_toggle.value==value or value=='ativo' and not form.status_toggle.value %}checked{%
                        endif %}>
                    <label for="status_{{ value }}_top">{{ label }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <form method="post" enctype="multipart/form-data" id="agentForm">
        {% csrf_token %}

        {% if form.errors %}
        <div
            style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <h4 style="color: #b91c1c; margin: 0 0 0.5rem 0; font-size: 1rem;">Por favor, corrija os erros abaixo:</h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #dc2626;">
                {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li>{% if field != '__all__' %}<strong>{{ field }}:</strong> {% endif %}{{ error }}</li>
                {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Campos hidden necessários -->
        {% if not is_create %}
        <input type="hidden" name="padaria" value="{{ agent.padaria.id }}">
        <input type="hidden" name="sector" value="{{ agent.sector|default:'geral' }}">
        <!-- Status toggle duplicado dentro do form para enviar o valor -->
        <input type="hidden" name="status_toggle" id="status_toggle_hidden"
            value="{{ form.status_toggle.value|default:'ativo' }}">
        {% else %}
        <!-- Campo sector com valor padrão para criação -->
        <input type="hidden" name="sector" value="geral" id="sector_hidden">
        {% endif %}

        <!-- SEÇÃO 1: BÁSICO -->
        <div style="margin-bottom: 2rem;">
            <h3
                style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--gray-900); display: flex; align-items: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                    <polyline points="10 9 9 9 8 9" />
                </svg>
                Informações Básicas
            </h3>

            {% if is_create %}
            <div class="form-group">
                {{ form.padaria.label_tag }}
                {{ form.padaria }}
                {% if form.padaria.help_text %}
                <p class="form-help">{{ form.padaria.help_text }}</p>
                {% endif %}
            </div>
            {% endif %}

            <div class="form-group">
                {{ form.name.label_tag }}
                {{ form.name }}
                {% if form.name.help_text %}
                <p class="form-help">{{ form.name.help_text }}</p>
                {% endif %}
            </div>

            <!-- Perfil do Agente -->
            <div class="form-group">
                <label class="form-label">Perfil do Agente</label>
                <p class="form-help" style="margin-bottom: 1rem;">Escolha um perfil para aplicar configurações padrão
                    automaticamente</p>

                <div class="preset-cards">
                    {% for key, preset in presets.items %}
                    <div class="preset-card" onclick="selectPreset('{{ key }}')">
                        <h4>{{ preset.label }}</h4>
                        <p>{{ preset.description }}</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Campo hidden para o preset -->
                <select name="agent_preset" id="id_agent_preset" style="display: none;">
                    <option value="">---------</option>
                    {% for key, preset in presets.items %}
                    <option value="{{ key }}">{{ preset.label }}</option>
                    {% endfor %}
                </select>
            </div>

            {% if is_create %}
            <div class="form-group">
                <label class="form-label">{{ form.status_toggle.label }}</label>
                <div class="status-toggle-container">
                    {% for value, label in form.status_toggle.field.choices %}
                    <div class="status-option {% if value == 'inativo' %}inactive{% endif %}">
                        <input type="radio" name="status_toggle" id="status_{{ value }}" value="{{ value }}" {% if
                            form.status_toggle.value|default:'ativo' == value %}checked{% endif %}>
                        <label for="status_{{ value }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Campo hidden para idioma (sempre pt-BR) -->
            <input type="hidden" name="language" value="pt-BR">
        </div>

        <div class="section-divider"></div>

        <!-- SEÇÃO 2: MENSAGENS RÁPIDAS -->
        <div style="margin-bottom: 2rem;">
            <h3
                style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--gray-900); display: flex; align-items: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                Mensagens Rápidas
            </h3>
            <p class="form-help" style="margin-bottom: 1.5rem;">
                Use <code>{{cliente_nome}}</code> e <code>{{agente_nome}}</code> como placeholders
            </p>

            <div class="form-group">
                {{ form.greeting.label_tag }}
                {{ form.greeting }}
                {% if form.greeting.help_text %}
                <p class="form-help">{{ form.greeting.help_text }}</p>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.out_of_hours_message.label_tag }}
                {{ form.out_of_hours_message }}
            </div>

            <div class="form-group">
                {{ form.fallback_message.label_tag }}
                {{ form.fallback_message }}
            </div>
        </div>

        <div class="section-divider"></div>

        <!-- SEÇÃO 2.5: CRONOGRAMA DE ATENDIMENTO -->
        <div style="margin-bottom: 2rem;">
            <h3
                style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--gray-900); display: flex; align-items: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                Defina seu Cronograma de Atendimento
            </h3>
            <p class="form-help" style="margin-bottom: 1.5rem;">
                Configure os dias e horários de funcionamento. A mensagem fora do horário será atualizada
                automaticamente.
            </p>

            <!-- Dias de funcionamento -->
            <div class="form-group">
                <label class="form-label" style="margin-bottom: 0.75rem; color: #f59e0b; font-weight: 600;">Dias de
                    funcionamento*</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    {% for value, label in form.working_days.field.choices %}
                    <label style="flex: 1; min-width: 120px;">
                        <input type="checkbox" name="working_days" value="{{ value }}" {% if form.working_days.value and
                            value in form.working_days.value %}checked{% endif %}
                            onchange="toggleDaySchedule('{{ value }}'); updateOutOfHoursMessage();"
                            style="display: none;">
                        <div class="day-button"
                            style="padding: 0.75rem; text-align: center; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 600; font-size: 0.875rem;">
                            {{ label }}
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Horários específicos por dia -->
            <div id="scheduleContainer" style="margin-top: 1.5rem;">
                {% for value, label in form.working_days.field.choices %}
                <div id="schedule_{{ value }}" class="day-schedule"
                    style="display: none; background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #e5e7eb;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #f59e0b;">{{ label }}</h4>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label" for="start_{{ value }}">Horário de Abertura</label>
                            <input type="time" id="start_{{ value }}" name="schedule_{{ value }}_start"
                                class="form-input schedule-time" onchange="updateOutOfHoursMessage()" value="07:00">
                        </div>
                        <div>
                            <label class="form-label" for="end_{{ value }}">Horário de Fechamento</label>
                            <input type="time" id="end_{{ value }}" name="schedule_{{ value }}_end"
                                class="form-input schedule-time" onchange="updateOutOfHoursMessage()" value="17:00">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Campos hidden antigos (manter para compatibilidade) -->
            <input type="hidden" name="morning_start" id="morning_start_hidden">
            <input type="hidden" name="morning_end" id="morning_end_hidden">
            <input type="hidden" name="afternoon_start" id="afternoon_start_hidden">
            <input type="hidden" name="afternoon_end" id="afternoon_end_hidden">
        </div>

        <!-- BOTÕES DE AÇÃO -->
        <div style="display: flex; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
            <button type="submit" class="btn btn-primary"
                style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    {% if is_create %}
                    <path d="M12 5v14M5 12h14" />
                    {% else %}
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                    {% endif %}
                </svg>
                {% if is_create %}Criar Agente{% else %}Salvar Alterações{% endif %}
            </button>
            <a href="{% url 'agents:list' %}" class="btn btn-secondary">
                Cancelar
            </a>
        </div>
    </form>
</div>

<script>
    function selectPreset(key)
    {
        // Atualizar campo hidden
        document.querySelector('select[name="agent_preset"]').value = key;

        // Atualizar visual
        document.querySelectorAll('.preset-card').forEach(card =>
        {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    }

    function toggleTransferFields()
    {
        const checkbox = document.querySelector('input[name="enable_human_transfer"]');
        const fields = document.getElementById('transferFields');

        if (checkbox.checked)
        {
            fields.style.display = 'block';
        } else
        {
            fields.style.display = 'none';
        }
    }

    // Inicializar preset selecionado
    document.addEventListener('DOMContentLoaded', function ()
    {
        const selectedPreset = document.querySelector('select[name="agent_preset"]').value;
        if (selectedPreset)
        {
            const cards = document.querySelectorAll('.preset-card');
            cards.forEach((card, index) =>
            {
                const presetKeys = ['sales', 'reception', 'support', 'neutral'];
                if (presetKeys[index] === selectedPreset)
                {
                    card.classList.add('selected');
                }
            });
        }

        // Toggle transfer fields
        const checkbox = document.querySelector('input[name="enable_human_transfer"]');
        if (checkbox)
        {
            checkbox.addEventListener('change', toggleTransferFields);
        }

        // Inicializar dias já selecionados
        document.querySelectorAll('input[name="working_days"]:checked').forEach(input =>
        {
            toggleDaySchedule(input.value, false);
        });
    });

    function toggleDaySchedule(dayValue, updateMessage = true)
    {
        const checkbox = document.querySelector(`input[name="working_days"][value="${dayValue}"]`);
        const scheduleDiv = document.getElementById(`schedule_${dayValue}`);

        if (checkbox && scheduleDiv)
        {
            if (checkbox.checked)
            {
                scheduleDiv.style.display = 'block';
            } else
            {
                scheduleDiv.style.display = 'none';
            }
        }

        if (updateMessage)
        {
            updateOutOfHoursMessage();
        }
    }

    function updateOutOfHoursMessage()
    {
        const daysMap = {
            'monday': 'Segunda',
            'tuesday': 'Terça',
            'wednesday': 'Quarta',
            'thursday': 'Quinta',
            'friday': 'Sexta',
            'saturday': 'Sábado',
            'sunday': 'Domingo'
        };

        // Obter dias selecionados com seus horários
        const selectedDaysData = [];
        document.querySelectorAll('input[name="working_days"]:checked').forEach(cb =>
        {
            const dayValue = cb.value;
            const startTime = document.getElementById(`start_${dayValue}`)?.value;
            const endTime = document.getElementById(`end_${dayValue}`)?.value;

            if (startTime && endTime)
            {
                selectedDaysData.push({
                    name: daysMap[dayValue],
                    start: startTime,
                    end: endTime
                });
            }
        });

        // Construir mensagem
        let message = 'Olá! No momento estamos fora do horário de atendimento.';

        if (selectedDaysData.length > 0)
        {
            message += ' Nosso horário de funcionamento é:\n';

            // Agrupar dias com mesmo horário
            const scheduleGroups = {};
            selectedDaysData.forEach(day =>
            {
                const schedule = `${day.start} às ${day.end}`;
                if (!scheduleGroups[schedule])
                {
                    scheduleGroups[schedule] = [];
                }
                scheduleGroups[schedule].push(day.name);
            });

            // Formatar mensagem
            const scheduleLines = [];
            Object.entries(scheduleGroups).forEach(([schedule, days]) =>
            {
                const daysText = days.length === 1
                    ? days[0]
                    : days.slice(0, -1).join(', ') + ' e ' + days[days.length - 1];
                scheduleLines.push(`${daysText} das ${schedule}`);
            });

            message += scheduleLines.join('\n');
        }

        message += '\n\nDeixe sua mensagem que retornaremos assim que possível!';

        // Atualizar o textarea
        const textarea = document.getElementById('id_out_of_hours_message');
        if (textarea)
        {
            textarea.value = message;
        }
    }
</script>

{% endblock %}