{% extends 'base.html' %}
{% load static %}

{% block title %}Relatórios - {{ organization.name }}{% endblock %}
{% block page_title %}Relatórios Empresariais{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* KPI Cards */
    .kpi-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #e5e7eb;
        position: relative;
        overflow: hidden;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }

    .kpi-card-title {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .kpi-card-value {
        color: #111827;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .kpi-card-subtext {
        color: #9ca3af;
        font-size: 0.875rem;
    }

    /* Chart Section */
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border: 1px solid #e5e7eb;
    }

    .section-title {
        color: #111827;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Tables Grid */
    .tables-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 1024px) {
        .tables-grid {
            grid-template-columns: 1fr;
        }
    }

    .table-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .custom-table {
        width: 100%;
        border-collapse: collapse;
    }

    .custom-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        color: #6b7280;
        font-weight: 600;
        font-size: 0.875rem;
        background-color: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    .custom-table td {
        padding: 0.75rem 1rem;
        color: #374151;
        font-size: 0.875rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .custom-table tr:last-child td {
        border-bottom: none;
    }

    .status-badge {
        display: inline-flex;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-approved {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-rejected {
        background-color: #fee2e2;
        color: #b91c1c;
    }

    /* Filters */
    .filters-bar {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .form-label {
        font-size: 0.875rem;
        color: #4b5563;
        font-weight: 500;
    }

    .form-input {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .btn-submit {
        background: #2563eb;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-submit:hover {
        background: #1d4ed8;
    }

    .empty-state-card {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
    }

    /* Header Moderno */
    .reports-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
    }

    .reports-header h2 {
        color: white;
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .reports-header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        margin: 0;
        font-weight: 300;
    }

    .reports-header p strong {
        font-weight: 600;
        color: #fff;
    }

    /* Filtros Card */
    .filters-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border: 1px solid #e5e7eb;
    }

    .filters-bar {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filters-bar .form-group {
        flex: 1;
        min-width: 200px;
    }

    .filters-bar .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .filters-bar .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s;
        background: #f9fafb;
    }

    .filters-bar .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .filters-bar .btn-submit {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
    }

    .filters-bar .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px -1px rgba(102, 126, 234, 0.4);
    }

    .filters-bar .btn-submit:active {
        transform: translateY(0);
    }

    .btn-clear {
        padding: 0.75rem 1.25rem;
        color: #6b7280;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
    }

    .btn-clear:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .header-icon {
        width: 2rem;
        height: 2rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 0.4rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Cabeçalho Moderno com Gradiente -->
<div class="reports-header">
    <h2>
        <svg class="header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Relatórios & Insights
    </h2>
    <p>Visão 360º do desempenho financeiro da <strong>{{ organization.name }}</strong></p>
</div>

<!-- Filtros em Card Moderno -->
<div class="filters-card">
    <form method="get" class="filters-bar">
        <div class="form-group">
            <label for="start_date" class="form-label">
                <svg style="display: inline; width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Data Início
            </label>
            <input type="date" id="start_date" name="start_date" value="{{ start_date|default:'' }}" class="form-input">
        </div>
        <div class="form-group">
            <label for="end_date" class="form-label">
                <svg style="display: inline; width: 1rem; height: 1rem; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Data Fim
            </label>
            <input type="date" id="end_date" name="end_date" value="{{ end_date|default:'' }}" class="form-input">
        </div>
        <button type="submit" class="btn-submit">
            <svg style="display: inline; width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Atualizar Dashboard
        </button>
        {% if start_date or end_date %}
        <a href="{% url 'organizations:report_detail' organization.slug %}" class="btn-clear">
            <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Limpar
        </a>
        {% endif %}
    </form>
</div>

{% if not mp_connected %}
<div class="alert alert-warning" style="margin-bottom: 2rem; border-left: 4px solid #f59e0b; background: #fffbeb; padding: 1rem; border-radius: 6px; color: #92400e;">
    <strong>Atenção:</strong> Sua conta do Mercado Pago parece não estar conectada ou não possui transações recentes. Alguns dados podem estar incompletos.
</div>
{% endif %}

<!-- KPI Grid -->
<div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
    <!-- Faturamento -->
    <div class="kpi-card">
        <div class="kpi-card-title">Faturamento Total</div>
        <div class="kpi-card-value" style="color: #10b981;">R$ {{ total_revenue|floatformat:2 }}</div>
        <div class="kpi-growth {% if revenue_growth >= 0 %}positive{% else %}negative{% endif %}">
            {% if revenue_growth >= 0 %}
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            +{{ revenue_growth|floatformat:1 }}%
            {% else %}
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
            {{ revenue_growth|floatformat:1 }}%
            {% endif %}
            <span style="color: #9ca3af; font-size: 0.75rem; font-weight: 400;">vs período anterior</span>
        </div>
    </div>

    <!-- Vendas -->
    <div class="kpi-card">
        <div class="kpi-card-title">Total de Vendas</div>
        <div class="kpi-card-value" style="color: #3b82f6;">{{ total_sales_count }}</div>
        <div class="kpi-growth {% if sales_growth >= 0 %}positive{% else %}negative{% endif %}">
            {% if sales_growth >= 0 %}
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            +{{ sales_growth|floatformat:1 }}%
            {% else %}
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
            {{ sales_growth|floatformat:1 }}%
            {% endif %}
        </div>
    </div>

    <!-- Ticket Médio -->
    <div class="kpi-card">
        <div class="kpi-card-title">Ticket Médio</div>
        <div class="kpi-card-value" style="color: #8b5cf6;">R$ {{ avg_ticket|floatformat:2 }}</div>
        <div class="kpi-card-subtext">Por venda realizada</div>
    </div>

    <!-- Taxa de Problemas -->
    <div class="kpi-card">
        <div class="kpi-card-title">Cancelamentos/Reembolsos</div>
        <div class="kpi-card-value" style="color: {% if refund_rate > 5 %}#ef4444{% else %}#f59e0b{% endif %};">{{ refund_rate|floatformat:1 }}%</div>
        <div class="kpi-card-subtext">Do total de transações</div>
    </div>
</div>

<!-- Charts Grid -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Evolução -->
    <div class="chart-container" style="margin-bottom: 0;">
        <div class="section-title">
            Faturamento Diário
        </div>
        <div style="height: 250px; position: relative; width: 100%;">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- Distribuição de Status -->
    <div class="chart-container" style="margin-bottom: 0;">
        <div class="section-title">
            Status dos Pedidos
        </div>
        <div style="height: 200px; display: flex; justify-content: center;">
            <canvas id="statusChart"></canvas>
        </div>
        <div style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280; text-align: center;">
            Visão geral da saúde das transações.
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Top Produtos -->
    <div class="table-card" style="margin-bottom: 0;">
        <div class="section-title">Top Produtos (Receita)</div>
        <div style="height: 300px; overflow-y: auto;">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products_sold %}
                    <tr>
                        <td style="font-weight: 500;">{{ product.description|truncatechars:30 }}</td>
                        <td>{{ product.qty }}</td>
                        <td>R$ {{ product.revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="empty-state-card">Nenhum dado.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Payment Methods Chart -->
    <div class="chart-container" style="margin-bottom: 0;">
        <div class="section-title">Meios de Pagamento</div>
        <div style="height: 200px; display: flex; justify-content: center;">
            <canvas id="methodsChart"></canvas>
        </div>
        <!-- Mini Tabela -->
        <div style="margin-top: 1.5rem;">
            <table class="custom-table" style="font-size: 0.85rem;">
                <thead>
                    <tr>
                        <th>Método</th>
                        <th>Volume</th>
                        <th>Qtd. Vendas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pm in payment_methods %}
                    <tr>
                        <td style="text-transform: capitalize;">{{ pm.method }}</td>
                        <td style="font-weight: 600; color: #10b981;">R$ {{ pm.revenue|floatformat:0 }}</td>
                        <td style="color: #6b7280;">{{ pm.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Últimas Transações -->
<div class="table-card">
    <div class="section-title">Histórico de Transações</div>
    <div style="overflow-x: auto;">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Status</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in recent_transactions %}
                <tr>
                    <td>{{ tx.created_at|date:"d/m/Y H:i" }}</td>
                    <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ tx.description }}
                    </td>
                    <td>
                        {% if tx.status == 'approved' %}
                        <span class="status-badge status-approved">Aprovado</span>
                        {% elif tx.status == 'pending' or tx.status == 'in_process' %}
                        <span class="status-badge status-pending">Pendente</span>
                        {% elif tx.status == 'refunded' %}
                        <span class="status-badge status-rejected" style="background: #e0f2fe; color: #0284c7;">Estornado</span>
                        {% else %}
                        <span class="status-badge status-rejected">{{ tx.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td style="font-family: monospace; font-size: 0.95rem;">R$ {{ tx.amount|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="empty-state-card">Nenhuma transação.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .kpi-growth {
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .kpi-growth.positive { color: #10b981; }
    .kpi-growth.negative { color: #ef4444; }
    
    .w-4 { width: 1rem; }
    .h-4 { height: 1rem; }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Gráfico de Evolução (Line) ---
        const ctxSales = document.getElementById('salesChart').getContext('2d');
        const salesGradient = ctxSales.createLinearGradient(0, 0, 0, 300);
        salesGradient.addColorStop(0, 'rgba(59, 130, 246, 0.25)');
        salesGradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

        new Chart(ctxSales, {
            type: 'line',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'Receita',
                    data: {{ chart_data|safe }},
                    borderColor: '#3b82f6',
                    backgroundColor: salesGradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.35,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { borderDash: [4, 4], color: '#f3f4f6' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // --- 2. Gráfico de Status (Doughnut) ---
        const statusData = {{ status_data|safe }};
        const statusLabels = {{ status_labels|safe }};
        const statusColors = statusLabels.map(s => {
            // Aprovado - Verde
            if(s.includes('approved') || s.includes('Aprovado')) return '#10b981';
            
            // Pendente - Amarelo/Laranja
            if(s.includes('pending') || s.includes('Pendente') || s.includes('Processamento') || s.includes('Aguardando')) return '#f59e0b';
            
            // Recusado - Vermelho (qualquer tipo de recusa)
            if(s.includes('Recusado') || s.includes('rejected') || s.includes('Alto Risco') || 
               s.includes('Insuficiente') || s.includes('Inválido') || s.includes('Bloqueado')) return '#ef4444';
            
            // Reembolsado/Estornado - Roxo
            if(s.includes('Reembolsado') || s.includes('refunded') || s.includes('Estornado') || s.includes('charged_back')) return '#8b5cf6';
            
            // Cancelado - Cinza escuro
            if(s.includes('Cancelado') || s.includes('cancelled')) return '#64748b';
            
            // Outros - Cinza claro
            return '#9ca3af';
        });

        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: statusColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } }
                }
            }
        });

        // --- 3. Gráfico de Métodos (Pie/Polar) ---
        const pmData = {{ pm_data|safe }};
        const pmLabels = {{ pm_labels|safe }};
        
        new Chart(document.getElementById('methodsChart'), {
            type: 'pie',
            data: {
                labels: pmLabels,
                datasets: [{
                    data: pmData,
                    backgroundColor: ['#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#64748b'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12 } }
                }
            }
        });
    });
</script>
{% endblock %}
